<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Suivi de commande</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
input, button {
  padding: 10px; font-size: 16px; margin-right: 5px; border-radius: 5px; border: 1px solid #ccc;
}
button { background: #007bff; color: white; border: none; cursor: pointer; }
button:hover { background: #0056b3; }

.suivi-container { width: 600px; margin-top: 30px; }
.status-text { text-align: center; font-weight: bold; margin-bottom: 10px; }

.status-bar {
  background-color: #eee;
  height: 20px;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress {
  background-color: #007bff;
  height: 100%;
  width: 0%;
  transition: width 0.5s;
  border-radius: 10px 0 0 10px;
}

.dates {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-top: 5px;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

<h2>Suivi de commande</h2>
<input type="text" id="trackingInput" placeholder="Entrez numéro de suivi">
<button onclick="chercherTracking()">Rechercher</button>

<div class="suivi-container" id="suiviContainer" style="display:none;">
  <div class="status-text" id="statusText">Status</div>
  <div class="status-bar">
    <div class="progress" id="progressBar"></div>
  </div>
  <div class="dates">
    <span id="startDate">--/--/----</span>
    <span id="endDate">--/--/----</span>
  </div>
</div>

<script>
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKpSm_qWcZU7uSvDDEzlN-VxhetgDfYgbT8Q4gdDfz3CiQNZprQfaLxIqj4MaEKxm2PyOMOwG_FAR0/pub?gid=1260274725&single=true&output=csv";
let rows = [];

// Fonction pour parser jj/mm/aaaa
function parseDateDMY(str) {
  const [day, month, year] = str.split("/").map(Number);
  return new Date(year, month - 1, day);
}

async function chargerCSV() {
  const res = await fetch(urlCSV);
  const text = await res.text();
  rows = Papa.parse(text, {header: false, skipEmptyLines: true}).data;
}

function calculerProgression(dateTraitementStr, dateLivraisonStr) {
  const today = new Date();
  const dateTraitement = parseDateDMY(dateTraitementStr);
  const dateLivraison = parseDateDMY(dateLivraisonStr);

  if (today < dateTraitement) return {status: "En attente", percent: 0};
  if (today >= dateLivraison) return {status: "Livré", percent: 100};

  const totalDays = (dateLivraison - dateTraitement) / (1000*60*60*24);
  const elapsedDays = (today - dateTraitement) / (1000*60*60*24);
  const percent = Math.min(Math.max((elapsedDays / totalDays)*100, 0), 100);

  let status = "En cours";
  if (elapsedDays >= 2) status = "Pris en charge par le livreur";

  return {status, percent};
}

async function chercherTracking() {
  if (rows.length === 0) await chargerCSV();
  const input = document.getElementById("trackingInput").value.trim();
  if (!input) { alert("Veuillez entrer un numéro de suivi"); return; }

  const ligne = rows.find(r => {
    const tracking = r[16];
    if (!tracking) return false;
    const clean = tracking.replace(/"/g,'').trim().toUpperCase();
    return clean === input.toUpperCase();
  });

  if (!ligne) { alert("Numéro de suivi non trouvé"); return; }

  const dateTraitement = ligne[5]; // F
  const dateLivraison = ligne[15]; // P
  const {status, percent} = calculerProgression(dateTraitement, dateLivraison);

  document.getElementById("suiviContainer").style.display = "block";
  document.getElementById("statusText").innerText = status + ` (${Math.round(percent)}%)`;
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("startDate").innerText = dateTraitement;
  document.getElementById("endDate").innerText = dateLivraison;
}
</script>

</body>
</html>
